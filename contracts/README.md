# Contracts

This directory defines stable interfaces between `apps/ts` and `apps/bt`.

## Policy

- Treat contract changes as versioned changes (additive vs breaking).
- If a breaking change is required, create a new versioned contract file.
- Keep contracts implementation-agnostic; no internal details.

## Versioning Rules

| Change Type | Severity | Examples |
|---|---|---|
| **Additive (minor)** | Non-breaking | New optional field, new endpoint, new enum value |
| **Breaking (major)** | Breaking | Field deletion, type change, new required field, field rename |

- Additive changes: bump minor version (e.g., `v1` stays `v1`, add field with default)
- Breaking changes: create new versioned file (e.g., `v1` -> `v2`)
- All schema files follow semantic versioning embedded in filename

## Change Process

1. **PR**: Schema changes must be submitted via Pull Request
2. **Review**: Changes reviewed for backwards compatibility
3. **Type regeneration**: Run `bun run --filter @trading25/shared bt:sync` after bt schema changes
4. **Test**: Verify `type-compatibility-check.ts` compiles and all tests pass
5. **CI**: Automated checks validate contract integrity on every push

## Dependency Direction Rules

| Direction | Status | Notes |
|---|---|---|
| bt -> ts | **Allowed** | bt accesses data via ts/api REST endpoints |
| ts -> bt | **Scheduled for removal** | Phase 3 will migrate ts endpoints to FastAPI |

- Enforced by `scripts/check-dep-direction.sh` (integrated into CI)
- See `scripts/dep-direction-allowlist.txt` for current exceptions
- Reference: [dependency audit report](../docs/reports/dependency-audit-phase1b.md)

## File Naming Convention

New schema files must follow: `{domain}-{purpose}-v{N}.schema.json`

Examples:
- `dataset-db-schema-v2.json`
- `backtest-run-manifest-v1.schema.json`
- `strategy-config-v1.schema.json`

## Files

| File | Status | Description |
|---|---|---|
| `dataset-schema.json` | **Deprecated** | Minimal dataset snapshot schema (legacy v1). Do not use for new work. |
| `dataset-db-schema-v2.json` | **Active** | Dataset DB schema contract aligned with `apps/ts` Drizzle tables (395 lines). Use this for all new development. |
| `backtest-run-manifest-v1.schema.json` | **Active** | Backtest run manifest emitted by `apps/bt`. |
| `strategy-config-v1.schema.json` | **Active** | Strategy YAML schema validated by `apps/bt`. |
| `hono-openapi-baseline.json` | **Frozen** | Hono OpenAPI snapshot frozen as Phase 3 migration baseline. Do not modify until Phase 3 completes. |

## OpenAPI Snapshots (Referenced)

- `apps/ts/packages/shared/openapi/bt-openapi.json`: `apps/bt` OpenAPI snapshot used for type sync.
- `apps/ts/packages/api/openapi.json`: `apps/ts` OpenAPI snapshot generated by the API server.

## Dataset Schema Migration Note

`dataset-schema.json` (v1) is retained for reference compatibility only.
All new development must use `dataset-db-schema-v2.json` as the authoritative schema.
The v2 schema is aligned with the `apps/ts` Drizzle ORM tables and covers all dataset DB tables.

## Snapshot Strategy (ADR-002)

**Decision**: SQLite-based snapshots (per ADR-002 in unified roadmap).

**Approach**:
- `apps/ts` outputs a `manifest.json` containing schema version and table hashes
- `apps/bt` validates the manifest before loading data
- Manifest fields: `schema_version`, `table_checksums`, `created_at`, `generator`

**Implementation**: Deferred to Phase 3 prerequisite work. Policy only confirmed here.
